% This is an experimental script to be used in MATLAB with Psychtoolbox. The initial setting are based on 
Psychtoolbox tutorials by Peter Scarfe, the rest is written by me.

% This script is currently in development

% Clear the workspace and the screen
sca;

% set subject name and condtion
subID = ('Lexie')
condition = 1

% Default setup for Psychtoolbox
PsychDefaultSetup(2); 

% Get the screen numbers
screens = Screen('Screens');

% Draw to the external screen if avaliable
screenNumber = max(screens);

% skip synctest for now
Screen('Preference', 'SkipSyncTests', 1);

% Define black and white
white = WhiteIndex(screenNumber);
black = BlackIndex(screenNumber);
grey = white / 2;
inc = white - grey;

%% Keyboard setup
KbName('UnifyKeyNames');
KbCheckList = [KbName('space'),KbName('q'),KbName('c'),KbName('v')];
RestrictKeysForKbCheck(KbCheckList);

% Set up the output file
resultsFolder = 'results';
outputfile = fopen([resultsFolder '/resultfile_' num2str(subID) '.txt'],'a');
fprintf(outputfile, 'subID\t Condition\t trial\t order\t probabiltyA\t probabiltyB\t probabilityC\t response\t rewarded\t score\n');

%% Load trial list. This is a file which contains the probabilities for the 2-3 bandits used in the task on each trial, and the 
order in which theh will be presented.

load('schedule3.mat')
trials = schedule3
trials = transpose(trials);

%% Screen set up

% Open an on screen window
[window, windowRect] = PsychImaging('OpenWindow', screenNumber, white);

% Get the size of the on screen window
[screenXpixels, screenYpixels] = Screen('WindowSize', window);

% Query the frame duration
ifi = Screen('GetFlipInterval', window);

% Get the centre coordinate of the window
[xCenter, yCenter] = RectCenter(windowRect);

% Add height and width
W=windowRect(RectRight); % screen width
H=windowRect(RectBottom); % screen height

% Set up alpha-blending for smooth (anti-aliased) lines
Screen('BlendFunction', window, 'GL_SRC_ALPHA', 'GL_ONE_MINUS_SRC_ALPHA');

%% find stimuli position

% Get the size of the on screen window in pixels
[screenXpixels, screenYpixels] = Screen('WindowSize', window);

% Get the centre coordinate of the window in pixels
[xCenter, yCenter] = RectCenter(windowRect);

% define rectangle to draw
baseRect = [0 0 1000 800];

% Center the rectangle on the centre of the screen using fractional pixel
% values.
centered = CenterRectOnPointd(baseRect, (xCenter), yCenter);

%% Load images to draw. The indices in this section will depend on your image directory, 

imageNames = dir('images2');
imageNames = struct2cell(imageNames);

for i = 18:32
    
    images{1,(i-17)} = imread(['images2/' imageNames{1,i}]);
    
end

for i = 1:length(images)
    
    image{i} = Screen('MakeTexture', window, images{i});
    
end


%% text settings

Screen('TextSize', window, 55);
%Screen('TextFont', window, 'Courier');


%% run the experiment

score = 0

% Start screen
Screen('DrawText',window,'Press the space bar to begin', (W/2-300), (H/2));
Screen('Flip',window)

% Wait for subject to press spacebar
while 1
    [keyIsDown,secs,keyCode] = KbCheck;
    if keyCode(KbName('space'))==1
        break
    end
end

% % % Flip to the screen
% Screen('Flip', window);

%for t = trials(1,:)

for t = 1:length(trials)
    
 
    % retrieve probability a choice is rewarded
    probabilityA = trials(2,t);
    probabilityB = trials(3,t);
    order = trials(4,t);
    probabilityC = trials(5,t);
        
    % decide which option to display
        
        if order == 1 % show card A

            % draw the card
            Screen('DrawTexture', window, image{1}, [], centered);
            
            % draw the current score
            sctext = num2str(score)
            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
            
            Screen('Flip', window);
            
            
            
            % Wait for participant choice

            % close window if escape is pressed
            while 1
            [keyIsDown,secs, keyCode] = KbCheck;
           % if keyCode('ESCAPE')
                if keyCode(KbName('q'))==1
                sca;
                Screen('CloseAll');
                return

            % if participant responds with 1 = red

            %elseif keyCode('1')
            elseif keyCode(KbName('c'))==1
                
                response = 1;
                
                x = rand

                        if x < probabilityA % probability of A is the probability reward is given after choosing red
                            
                            Screen('DrawTexture', window, image{2}, [], centered);
                            
                            rewarded = 1
                            score = score + 10
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);


                        else 

                            Screen('DrawTexture', window, image{3}, [], centered);
                            
                            rewarded = 0
                            score = score - 5
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);

                        
                        end

                        WaitSecs(1)
                        
                                                % Save results to file 'subID\t Condition\t trial\t card\t response\t RT\n'
                       fprintf(outputfile, '%s\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\n',...
                            subID, condition, trials(1,t), order, probabilityA, probabilityB, probabilityC, response, rewarded, score); 
                        
                        break
                        
           
                        
            % if participant responds with 2 = blue
            
            elseif keyCode(KbName('v'))==1
                
                response = 2
                
                x = rand
                
                if x < (1 - probabilityA) 
                    
                            Screen('DrawTexture', window, image{4}, [], centered);
                            
                            rewarded = 1
                            score = score + 10
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);


                        else 

                            Screen('DrawTexture', window, image{5}, [], centered);

                            rewarded = 0
                            score = score - 5
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);

                        
                end

                        WaitSecs(1)
                        
                                                % Save results to file 'subID\t Condition\t trial\t card\t response\t RT\n'
                        fprintf(outputfile, '%s\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\n',...
                            subID, condition, trials(1,t), order, probabilityA, probabilityB, probabilityC, response, rewarded, score); 
                        
                        break
                        
           
            end
            
            end 
            

    elseif order == 0 % show card B
        
            % draw the card
            Screen('DrawTexture', window, image{6}, [], centered);
            
            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);

            
            % Wait for participant choice

            % close window if escape is pressed
            while 1
            [keyIsDown,secs, keyCode] = KbCheck;
            if keyCode(KbName('q'))==1
                sca;
                Screen('CloseAll');
                return

            % if participant responds with 1 = red

            elseif keyCode(KbName('c'))==1
                
                response = 1;
                
                x = rand

                       if x < probabilityB 
                            
                            Screen('DrawTexture', window, image{7}, [], centered);
                            
                            rewarded = 1
                            score = score + 10
                           
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);



                        else 

                            Screen('DrawTexture', window, image{8}, [], centered);
                            
                            rewarded = 0
                            score = score - 5
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);

                        
                        end

                        record(3,t) = probabilityB
                        WaitSecs(1)
                        
                                                % Save results to file 'subID\t Condition\t trial\t card\t response\t RT\n'
                        fprintf(outputfile, '%s\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\n',...
                            subID, condition, trials(1,t), order, probabilityA, probabilityB, probabilityC, response, rewarded, score); 
                        
                        break
           
                        
            % if participant responds with 2 = blue
            
            elseif keyCode(KbName('v'))==1
                
                response = 2
                
                x = rand
                
                         if x < (1 - probabilityB)
                    
                            Screen('DrawTexture', window, image{9}, [], centered);

                            rewarded = 1
                            score = score + 10
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);


                        else 

                            Screen('DrawTexture', window, image{10}, [], centered);

                            rewarded = 0
                            score = score - 5
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);

                        
                        end

                        record(3,t) = probabilityB
                        WaitSecs(1)
                        
                        % Save results to file 'subID\t Condition\t trial\t card\t response\t RT\n'
                        fprintf(outputfile, '%s\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\n',...
                            subID, condition, trials(1,t), order, probabilityA, probabilityB, probabilityC, response, rewarded, score); 
                        break
                        
           
            end
                        
            end
              
        elseif order == 2 % show card C

            % draw the card
            Screen('DrawTexture', window, image{11}, [], centered);
            
            % draw the current score
            sctext = num2str(score)
            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
            
            Screen('Flip', window);
            
            
            
            % Wait for participant choice

            % close window if escape is pressed
            while 1
            [keyIsDown,secs, keyCode] = KbCheck;
           % if keyCode('ESCAPE')
                if keyCode(KbName('q'))==1
                sca;
                Screen('CloseAll');
                return

            % if participant responds with 1 = red

            %elseif keyCode('1')
            elseif keyCode(KbName('c'))==1
                
                response = 1;
                
                x = rand

                        if x < probabilityC % probability of C is the probability reward is given after choosing red
                            
                            Screen('DrawTexture', window, image{12}, [], centered);
                            
                            rewarded = 1
                            score = score + 10
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);


                        else 

                            Screen('DrawTexture', window, image{13}, [], centered);
                            
                            rewarded = 0
                            score = score - 5
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);

                        
                        end

                        record(3,t) = probabilityC
                        WaitSecs(1)
                        
                                                % Save results to file 'subID\t Condition\t trial\t card\t response\t RT\n'
                        fprintf(outputfile, '%s\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\n',...
                            subID, condition, trials(1,t), order, probabilityA, probabilityB, probabilityC, response, rewarded, score);  
                        
                        break
                        
           
                        
            % if participant responds with 2 = blue
            
            elseif keyCode(KbName('v'))==1
                
                response = 2
                
                x = rand
                
                if x < (1 - probabilityC) 
                    
                            Screen('DrawTexture', window, image{14}, [], centered);
                            
                            rewarded = 1
                            score = score + 10
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);


                        else 

                            Screen('DrawTexture', window, image{15}, [], centered);

                            rewarded = 0
                            score = score - 5
                            
                            % add score
                            sctext = num2str(score)
                            Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));
                            Screen('Flip', window);

                        
                end

                        WaitSecs(1)
                        
                                                % Save results to file 'subID\t Condition\t trial\t card\t response\t RT\n'
                        fprintf(outputfile, '%s\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\t %f\n',...
                            subID, condition, trials(1,t), order, probabilityA, probabilityB, probabilityC, response, rewarded, score);  
                        
                        break
                        
           
            end
            
            end
            
   end


 
end


%% Finish screen

% add score
sctext = num2str(score)
Screen('DrawText',window,['Score: ' sctext], (W/2-700), (H/2));

Screen('DrawText',window,'DANKE', (W/2-300), (H/2));
Screen('Flip',window)

fclose(outputfile); 

% Wait for subject to press spacebar
 while 1
            [keyIsDown,secs, keyCode] = KbCheck;
            if keyCode(KbName('q'))==1
                sca;
%                 Screen('CloseAll');
                return
            end
 end
 

 %% %%  
